<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Recarga de Sesi√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-sync-alt"></i> Test Recarga de Sesi√≥n - Sorteo</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Simular Reserva</h6>
                                <div class="mb-3">
                                    <label class="form-label">N√∫mero Celular:</label>
                                    <input type="text" class="form-control" id="testPhone" value="2226536090">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre Completo:</label>
                                    <input type="text" class="form-control" id="testName" value="Juan P√©rez">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Minutos de reserva:</label>
                                    <select class="form-control" id="testMinutes">
                                        <option value="30">30 minutos</option>
                                        <option value="15">15 minutos</option>
                                        <option value="5">5 minutos</option>
                                        <option value="2">2 minutos (para prueba r√°pida)</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="simulateReservation()">
                                    <i class="fas fa-play"></i> Simular Reserva
                                </button>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Estado de Sesi√≥n</h6>
                                <div id="sessionStatus" class="mb-3"></div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="checkSession()">
                                        <i class="fas fa-search"></i> Verificar Sesi√≥n
                                    </button>
                                    <button class="btn btn-warning" onclick="window.location.reload()">
                                        <i class="fas fa-sync-alt"></i> Recargar P√°gina
                                    </button>
                                    <button class="btn btn-danger" onclick="clearSession()">
                                        <i class="fas fa-trash"></i> Limpiar Sesi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Temporizador simulado -->
                        <div class="alert alert-success mt-4" id="reservationAlert" style="display: none;">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="mb-1"><i class="fas fa-clock"></i> ¬°N√∫meros Reservados!</h5>
                                    <p class="mb-0">Tienes <strong><span id="reservationTimer">30:00</span></strong> para confirmar tu pago</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="button" class="btn btn-warning">
                                        <i class="fas fa-credit-card"></i> Ver Datos de Pago
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <h6><i class="fas fa-info-circle"></i> Instrucciones de Prueba:</h6>
                            <ol class="mb-0">
                                <li><strong>Simular reserva:</strong> Completa los datos y haz clic en "Simular Reserva"</li>
                                <li><strong>Verificar temporizador:</strong> Debe aparecer el cuadro verde con el tiempo restante</li>
                                <li><strong>Recargar p√°gina:</strong> El temporizador debe seguir apareciendo con el tiempo correcto</li>
                                <li><strong>Esperar expiraci√≥n:</strong> Al llegar a 0, debe desaparecer y limpiar la sesi√≥n</li>
                            </ol>
                        </div>
                        
                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let reservationTimer = null;
        
        // Funciones de sesi√≥n (copiadas del sorteo real)
        function saveUserSession(phoneNumber, fullName, selectedNumbers = [], reservationExpires = null) {
            const sessionData = {
                phoneNumber: phoneNumber,
                fullName: fullName,
                selectedNumbers: selectedNumbers,
                timestamp: Date.now(),
                reservationExpires: reservationExpires
            };
            localStorage.setItem('sorteo_user_session', JSON.stringify(sessionData));
            console.log('üíæ Sesi√≥n guardada:', sessionData);
            return sessionData;
        }
        
        function getUserSession() {
            try {
                const sessionData = localStorage.getItem('sorteo_user_session');
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    const maxAge = 24 * 60 * 60 * 1000; // 24 horas
                    if (Date.now() - parsed.timestamp < maxAge) {
                        return parsed;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error recuperando sesi√≥n:', error);
            }
            return null;
        }
        
        function clearUserSession() {
            localStorage.removeItem('sorteo_user_session');
            console.log('üóëÔ∏è Sesi√≥n limpiada');
        }
        
        // Funciones de prueba
        function simulateReservation() {
            const phone = document.getElementById('testPhone').value;
            const name = document.getElementById('testName').value;
            const minutes = parseInt(document.getElementById('testMinutes').value);
            
            if (!phone || !name) {
                showResult('Por favor completa todos los campos', 'warning');
                return;
            }
            
            const reservationExpires = Date.now() + (minutes * 60 * 1000);
            const session = saveUserSession(phone, name, [17, 22, 45], reservationExpires);
            
            startReservationTimer(minutes * 60);
            
            showResult(`Reserva simulada exitosamente:<br>
                       üì± Tel√©fono: ${session.phoneNumber}<br>
                       üë§ Nombre: ${session.fullName}<br>
                       üé´ N√∫meros: ${session.selectedNumbers.join(', ')}<br>
                       ‚è∞ Expira en: ${minutes} minutos`, 'success');
        }
        
        function startReservationTimer(seconds) {
            clearReservationTimer();
            
            const reservationAlert = document.getElementById('reservationAlert');
            const timerElement = document.getElementById('reservationTimer');
            
            if (reservationAlert) {
                reservationAlert.style.display = 'block';
            }
            
            let timeLeft = seconds;
            
            reservationTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                
                timerElement.textContent = `${minutes}:${String(secs).padStart(2, '0')}`;
                
                if (timeLeft <= 300) { // 5 minutos
                    timerElement.className = 'timer-warning';
                }
                if (timeLeft <= 60) { // 1 minuto
                    timerElement.className = 'timer-danger';
                }
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(reservationTimer);
                    timerElement.textContent = '¬°Tiempo agotado!';
                    
                    if (reservationAlert) {
                        reservationAlert.style.display = 'none';
                    }
                    
                    clearUserSession();
                    showResult('‚è∞ Tiempo de reserva expirado. Sesi√≥n limpiada autom√°ticamente.', 'warning');
                }
            }, 1000);
        }
        
        function clearReservationTimer() {
            if (reservationTimer) {
                clearInterval(reservationTimer);
                reservationTimer = null;
            }
            
            const reservationAlert = document.getElementById('reservationAlert');
            if (reservationAlert) {
                reservationAlert.style.display = 'none';
            }
            
            const timerElement = document.getElementById('reservationTimer');
            if (timerElement) {
                timerElement.textContent = '30:00';
                timerElement.className = '';
            }
        }
        
        function checkSession() {
            const session = getUserSession();
            if (session) {
                const age = Math.round((Date.now() - session.timestamp) / 1000 / 60);
                let timeLeft = 0;
                
                if (session.reservationExpires) {
                    timeLeft = Math.max(0, Math.floor((session.reservationExpires - Date.now()) / 1000));
                }
                
                showResult(`üìã Sesi√≥n activa encontrada:<br>
                           üì± Tel√©fono: ${session.phoneNumber}<br>
                           üë§ Nombre: ${session.fullName}<br>
                           üé´ N√∫meros: ${session.selectedNumbers.join(', ')}<br>
                           ‚è∞ Tiempo restante: ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2, '0')}<br>
                           üìÖ Creada hace: ${age} minutos`, 'info');
                
                if (timeLeft > 0) {
                    startReservationTimer(timeLeft);
                }
            } else {
                showResult('‚ùå No hay sesi√≥n activa', 'secondary');
            }
        }
        
        function clearSession() {
            clearReservationTimer();
            clearUserSession();
            showResult('üóëÔ∏è Sesi√≥n limpiada exitosamente', 'success');
        }
        
        function showResult(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        function updateSessionStatus() {
            const session = getUserSession();
            const statusDiv = document.getElementById('sessionStatus');
            
            if (session) {
                let timeLeft = 0;
                if (session.reservationExpires) {
                    timeLeft = Math.max(0, Math.floor((session.reservationExpires - Date.now()) / 1000));
                }
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Sesi√≥n Activa</strong><br>
                        üì± ${session.phoneNumber}<br>
                        ‚è∞ ${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2, '0')} restantes
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-secondary">
                        <strong>‚ùå Sin Sesi√≥n</strong><br>
                        No hay datos guardados
                    </div>
                `;
            }
        }
        
        // Inicializar al cargar la p√°gina
        window.onload = function() {
            updateSessionStatus();
            checkSession(); // Esto deber√≠a iniciar el temporizador si hay sesi√≥n activa
            
            // Actualizar estado cada 5 segundos
            setInterval(updateSessionStatus, 5000);
        };
    </script>
</body>
</html>
