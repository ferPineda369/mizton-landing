<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Codificación de Caracteres</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .json-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bug"></i> Debug Codificación de Caracteres</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Probar Nombre:</h6>
                                <div class="mb-3">
                                    <label class="form-label">Nombre a probar:</label>
                                    <input type="text" class="form-control" id="testName" value="José María" placeholder="Ingresa un nombre">
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="debugEncoding()">
                                        <i class="fas fa-search"></i> Debug Completo
                                    </button>
                                    <button class="btn btn-success" onclick="testRealAPI()">
                                        <i class="fas fa-flask"></i> Test API Real
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Casos Rápidos:</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="quickTest('José María')">
                                        José María
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="quickTest('Müller García')">
                                        Müller García
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="quickTest('Ángela Rodríguez')">
                                        Ángela Rodríguez
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="quickTest('Niño Hernández')">
                                        Niño Hernández
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div id="debugResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function debugEncoding() {
            const name = document.getElementById('testName').value;
            
            if (!name) {
                showResult('<div class="alert alert-warning">Por favor ingresa un nombre</div>');
                return;
            }
            
            showResult('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Analizando codificación...</div>');
            
            try {
                const formData = new FormData();
                formData.append('fullName', name);
                formData.append('phoneNumber', '2226536090');
                
                const response = await fetch('debug_encoding.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                let html = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Análisis Completo de Codificación</h6>
                        <p><strong>Nombre probado:</strong> "${name}"</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Datos Recibidos:</h6>
                            <div class="json-output">${JSON.stringify(data.received_data, null, 2)}</div>
                        </div>
                        <div class="col-md-6">
                            <h6>Info de Codificación:</h6>
                            <div class="json-output">${JSON.stringify(data.encoding_info, null, 2)}</div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Tests de Validación:</h6>
                            <div class="json-output">${JSON.stringify(data.validation_tests, null, 2)}</div>
                        </div>
                        <div class="col-md-6">
                            <h6>Resultado Final:</h6>
                            <div class="alert alert-${data.validation_result.is_valid ? 'success' : 'danger'}">
                                <strong>Estado:</strong> ${data.validation_result.is_valid ? 'VÁLIDO ✅' : 'INVÁLIDO ❌'}<br>
                                ${data.validation_result.errors.length > 0 ? '<strong>Errores:</strong> ' + data.validation_result.errors.join(', ') : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Casos de Prueba Automáticos:</h6>
                        <div class="json-output">${JSON.stringify(data.test_cases, null, 2)}</div>
                    </div>
                `;
                
                showResult(html);
                
            } catch (error) {
                showResult(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                        <p>${error.message}</p>
                    </div>
                `);
            }
        }
        
        async function testRealAPI() {
            const name = document.getElementById('testName').value;
            
            if (!name) {
                showResult('<div class="alert alert-warning">Por favor ingresa un nombre</div>');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('number', '17');
                formData.append('fullName', name);
                formData.append('phoneNumber', '2226536090');
                
                const response = await fetch('api/register_number.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                const alertClass = data.success ? 'success' : 'danger';
                const icon = data.success ? 'check-circle' : 'times-circle';
                
                showResult(`
                    <div class="alert alert-${alertClass}">
                        <h6><i class="fas fa-${icon}"></i> Test API Real</h6>
                        <p><strong>Nombre:</strong> "${name}"</p>
                        <p><strong>Resultado:</strong> ${data.success ? 'ÉXITO' : 'FALLO'}</p>
                        <p><strong>Mensaje:</strong> ${data.message}</p>
                    </div>
                `, true);
                
            } catch (error) {
                showResult(`
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error de Conexión</h6>
                        <p>${error.message}</p>
                    </div>
                `, true);
            }
        }
        
        function quickTest(name) {
            document.getElementById('testName').value = name;
            debugEncoding();
        }
        
        function showResult(html, append = false) {
            const resultsDiv = document.getElementById('debugResults');
            if (append) {
                resultsDiv.innerHTML += html;
            } else {
                resultsDiv.innerHTML = html;
            }
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Test automático al cargar
        window.onload = function() {
            showResult(`
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Debug de Codificación Listo</h6>
                    <p>Esta herramienta te ayudará a identificar problemas de codificación con caracteres acentuados.</p>
                    <ul class="mb-0">
                        <li><strong>Debug Completo:</strong> Analiza bytes, codificación y validación</li>
                        <li><strong>Test API Real:</strong> Prueba con la API de registro real</li>
                        <li><strong>Casos Rápidos:</strong> Prueba nombres problemáticos conocidos</li>
                    </ul>
                </div>
            `);
        };
    </script>
</body>
</html>
