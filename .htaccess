RewriteEngine On

# Configurar Content-Type para archivos WebP
<IfModule mod_mime.c>
    AddType image/webp .webp
</IfModule>

# Configurar headers para imágenes
<IfModule mod_headers.c>
    <FilesMatch "\.(webp|jpg|jpeg|png|gif|svg)$">
        Header set Cache-Control "public, max-age=31536000"
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Reglas para URLs de news
# 1. Códigos de referido en news index: /news/referido (6 caracteres exactos)
RewriteRule ^news/([a-zA-Z0-9]{6})/?$ news/index.php?ref=$1 [L,QSA]

# 2. Posts con referido: /news/slug-del-post/codigo-referido
RewriteRule ^news/([a-zA-Z0-9-]+)/([a-zA-Z0-9]{6})/?$ news/post.php?slug=$1&ref=$2 [L,QSA]

# 3. Posts sin referido: /news/slug-del-post (debe ir al final)
RewriteRule ^news/([a-zA-Z0-9-]+)/?$ news/post.php?slug=$1 [L,QSA]

# Reglas para códigos de referido - Redirigir a panel/register.php
# Excluir directorios y archivos existentes
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Excluir rutas específicas conocidas
RewriteCond %{REQUEST_URI} !^/(news|blog|api|assets|config|includes|docs|admin)(/.*)?$

# Excluir archivos con extensiones comunes
RewriteCond %{REQUEST_URI} !^/.*\.(php|html|css|js|jpg|jpeg|png|gif|svg|ico|pdf|zip|txt|xml|json)$

# Capturar códigos de referido de exactamente 6 caracteres alfanuméricos
# Redirigir a panel.mizton.cat/register.php con el código de referido
RewriteRule ^([a-zA-Z0-9]{6})/?$ https://panel.mizton.cat/register.php?ref=$1 [R=302,L,QSA]

# Redireccionar URLs antiguas con parámetro ref al nuevo formato
RewriteCond %{QUERY_STRING} ^ref=([a-zA-Z0-9]{6})$
RewriteRule ^index\.php$ https://panel.mizton.cat/register.php?ref=%1 [R=302,L]

# Redireccionar desde raíz con parámetro ref
RewriteCond %{QUERY_STRING} ^ref=([a-zA-Z0-9]{6})$
RewriteRule ^$ https://panel.mizton.cat/register.php?ref=%1 [R=302,L]
